import { GetDatasetQuery } from '../../../../../../graphql/dataset.generated';
import { DatasetStatsSummary as DatasetStatsSummaryObj } from '../../../../../../types.generated';
import { useBaseEntity } from '../../../../shared/EntityContext';
import { DatasetStatsSummary } from '../../../shared/DatasetStatsSummary';
import { getLastUpdatedMs } from '../../../shared/utils';

export const DatasetStatsSummarySubHeader = ({ properties }: { properties?: any }) => {
    const result = useBaseEntity<GetDatasetQuery>();
    const dataset = result?.dataset;

    const maybeStatsSummary = dataset?.statsSummary as DatasetStatsSummaryObj;

    const maybeLastProfile =
        dataset?.datasetProfiles && dataset.datasetProfiles.length ? dataset.datasetProfiles[0] : undefined;

    const fileCountPropertyIndex = dataset?.structuredProperties?.properties?.findIndex(
        (prop) => prop.structuredProperty?.urn === 'urn:li:structuredProperty:num_files'
    );
    const value = fileCountPropertyIndex !== undefined && fileCountPropertyIndex >= 0
        ? dataset?.structuredProperties?.properties?.[fileCountPropertyIndex]?.values?.[0]
        : undefined;
    const fileCount = value?.__typename === 'NumberValue' ? value.numberValue : undefined;

    const latestPartitionUSIndex = dataset?.structuredProperties?.properties?.findIndex(
        (prop) => prop.structuredProperty?.urn === 'urn:li:structuredProperty:max_date_us'
    );
    const latestPartitionUSValue = latestPartitionUSIndex !== undefined && latestPartitionUSIndex >= 0
        ? dataset?.structuredProperties?.properties?.[latestPartitionUSIndex]?.values?.[0]
        : undefined;
    const latestPartitionUS = latestPartitionUSValue?.__typename === 'StringValue' ? latestPartitionUSValue.stringValue : undefined;

    const latestPartitionEUIndex = dataset?.structuredProperties?.properties?.findIndex(
        (prop) => prop.structuredProperty?.urn === 'urn:li:structuredProperty:max_date_eu'
    );
    const latestPartitionEUValue = latestPartitionEUIndex !== undefined && latestPartitionEUIndex >= 0
        ? dataset?.structuredProperties?.properties?.[latestPartitionEUIndex]?.values?.[0]
        : undefined;
    const latestPartitionEU = latestPartitionEUValue?.__typename === 'StringValue' ? latestPartitionEUValue.stringValue : undefined;

    const columnCount = maybeLastProfile?.columnCount;
    const sizeInBytes = maybeLastProfile?.sizeInBytes;
    const totalSqlQueries = dataset?.usageStats?.aggregations?.totalSqlQueries;
    const queryCountLast30Days = maybeStatsSummary?.queryCountLast30Days;
    const uniqueUserCountLast30Days = maybeStatsSummary?.uniqueUserCountLast30Days;
    const lastUpdatedMs = getLastUpdatedMs(dataset?.properties, dataset?.operations);

    return (
        <DatasetStatsSummary
            fileCount={fileCount}
            columnCount={columnCount}
            sizeInBytes={sizeInBytes}
            totalSqlQueries={totalSqlQueries}
            queryCountLast30Days={queryCountLast30Days}
            uniqueUserCountLast30Days={uniqueUserCountLast30Days}
            lastUpdatedMs={lastUpdatedMs}
            latestPartitionUS={latestPartitionUS}
            latestPartitionEU={latestPartitionEU}
            shouldWrap={properties?.shouldWrap}
        />
    );
};
