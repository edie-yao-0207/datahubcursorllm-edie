{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Product usage schema",
  "type": "object",
  "properties": {
    "feature_name": {
      "type": "string",
      "description": "The name of the feature being tracked in the Product Usage dashboard."
    },
    "product_truth": {
      "type": "string",
      "description": "Optional link to the feature's Product Truth document"
    },
    "enablement_array": {
      "type": "array",
      "minItems": 1,
      "description": "Array on a feature's evolving enablement details. For features that have existed for a long time, only the latest details are needed.",
      "items": {
        "type": "object",
        "properties": {
          "licenses": {
            "type": "object",
            "description": "License configuration for this feature",
            "properties": {
              "skus": {
                "type": "array",
                "minItems": 1,
                "description": "List of SKUs that give access to this feature. All SKUs must start with 'LIC' and should exist in sku_to_featurebundle.go.",
                "items": {
                  "type": "string",
                  "pattern": "^LIC.*",
                  "description": "License SKU"
                }
              },
              "add_on_skus": {
                "type": "array",
                "minItems": 1,
                "description": "List of add-on SKUs that provide additional functionality for this feature. All SKUs must start with 'LIC' and should exist in sku_to_featurebundle.go. This is for managing license dependencies if an add-on SKU is also needed in addition to a core license SKU.",
                "items": {
                  "type": "string",
                  "pattern": "^LIC.*",
                  "description": "Add-on license SKU"
                }
              },
              "license_required": {
                "type": "boolean",
                "description": "Whether licenses are required for access. If a FF is in place, is a license also needed?"
              },
              "min_quantity": {
                "type": "integer",
                "default": 0,
                "description": "Minimum quantity required for the license to be considered valid"
              },
              "override_orgs": {
                "type": "array",
                "minItems": 1,
                "description": "List of org IDs that are not a part of the min_quantity check",
                "items": {
                  "type": "integer",
                  "description": "Organization ID"
                }
              }
            },
            "required": ["skus", "license_required"],
            "additionalProperties": false
          },
          "feature_flag_name": {
            "type": "array",
            "minItems": 1,
            "description": "Name of LaunchDarkly FFs giving access to the feature.",
            "items": {
              "type": "string",
              "description": "Name of LaunchDarkly FFs giving access to the feature."
            }
          },
          "release_phase": {
            "type": "string",
            "description": "Release phase of feature (possible values are Closed Beta, Open Beta, GA).",
            "enum": ["Closed Beta", "Open Beta", "GA"]
          },
          "opt_in_scopes": {
            "type": "array",
            "minItems": 1,
            "description": "List of opt-in scopes that have access to this feature (can ignore if not applicable). Acceptable scopes can be found in https://github.com/samsara-dev/backend/blob/master/go/src/samsaradev.io/infra/releasemanagement/releasemanagementproto/feature_scope.proto.",
            "items": {
              "type": "integer",
              "description": "Opt-in scope where feature is applicable (if it's not global)",
              "enum": [0, 1, 2, 3]
            }
          },
          "locales": {
            "type": "array",
            "minItems": 1,
            "description": "List of org locales where the feature is enabled (can ignore if not applicable). Acceptable locales can be found in go/src/samsaradev.io/helpers/l10n/l10nconstants/main.go. Use na_all_locales or eu_all_locales if wanting to cover all locales in a region.",
            "items": {
              "type": "string",
              "description": "Locale where feature is applicable (if it's not global)"
            }
          },
          "release_types": {
            "type": "array",
            "minItems": 1,
            "description": "List of release types that have access to this feature (EA, Phase 1, Phase 2)",
            "items": {
              "type": "string",
              "enum": ["Early Adopter", "Phase 1", "Phase 2"]
            }
          },
          "serves_all": {
            "type": "boolean",
            "description": "Whether this feature serves all customers or not (no other fields should be needed in this case)"
          },
          "regions": {
            "type": "array",
            "minItems": 1,
            "description": "List of cloud regions where the feature is enabled (can ignore if not applicable). Current options are either 'us' or 'eu'. Don't use this field if the feature is global.",
            "items": {
              "type": "string",
              "description": "Region where feature is applicable (if it's not global)",
              "enum": ["us", "eu"]
            }
          },
          "effective_date": {
            "type": "string",
            "format": "date",
            "description": "The date when this feature enablement configuration becomes effective"
          }
        },
        "additionalProperties": false,
        "required": ["effective_date"],
        "anyOf": [
          {
            "properties": {
              "serves_all": { "const": true }
            },
            "required": ["serves_all"],
            "not": {
              "anyOf": [
                { "required": ["licenses"] },
                { "required": ["feature_flag_name"] },
                { "required": ["opt_in_scopes"] },
                { "required": ["release_phase"] }
              ]
            }
          },
          {
            "properties": {
              "licenses": {
                "properties": {
                  "license_required": { "const": true }
                },
                "required": ["skus", "license_required"]
              }
            },
            "required": ["release_phase", "licenses"],
            "allOf": [
              {
                "properties": {
                  "licenses": {
                    "properties": {
                      "skus": {
                        "type": "array",
                        "minItems": 1
                      }
                    }
                  }
                }
              }
            ]
          },
          {
            "properties": {
              "licenses": {
                "properties": {
                  "license_required": { "const": false }
                },
                "required": ["license_required"]
              }
            },
            "required": ["release_phase", "licenses"]
          },
          {
            "properties": {
              "feature_flag_name": { "type": "array" }
            },
            "required": ["release_phase", "feature_flag_name"],
            "not": {
              "anyOf": [{ "required": ["licenses"] }, { "required": ["serves_all"] }]
            }
          },
          {
            "not": {
              "anyOf": [
                { "properties": { "serves_all": { "const": true } } },
                { "properties": { "licenses": { "properties": { "license_required": { "const": true } } } } },
                { "properties": { "licenses": { "properties": { "license_required": { "const": false } } } } },
                { "required": ["feature_flag_name"] }
              ]
            },
            "required": ["release_phase"]
          }
        ]
      }
    },
    "usage_array": {
      "type": "array",
      "minItems": 1,
      "description": "Array of usage details for this feature. If there's only one usage query, then only the latest is needed (effective-dated otherwise).",
      "items": {
        "type": "object",
        "properties": {
          "route_names": {
            "type": "array",
            "minItems": 1,
            "description": "List of Cloud dashboard route names that if visited by a customer, count as usage. If usage does not include visiting a Cloud dashboard route, leave this blank.",
            "items": {
              "type": "string",
              "description": "Cloud route name. Route name should exist in route_names.ts"
            }
          },
          "mixpanel_metric_names": {
            "type": "array",
            "minItems": 1,
            "description": "List of Mixpanel metrics that if triggered by a customer, trigger usage. If usage does not include engaging with Mixpanel events, then leave this blank. It is assumed the metrics exist in Databricks already (please add if not following the guide here: https://samsara.atlassian-us-gov-mod.net/wiki/spaces/DATA/pages/17920495/How+To+Add+Mixpanel+Table+s+to+Data+Lake).",
            "items": {
              "type": "string",
              "description": "Mixpanel metric name"
            }
          },
          "alerts": {
            "type": "object",
            "description": "List of alert triggers/actions that if actioned, would count as usage. If alerts are not involved in usage, then leave this blank.",
            "properties": {
              "trigger_types": {
                "type": "array",
                "minItems": 1,
                "description": "List of alert triggers that if triggered, would count as usage. If alerts are not involved in usage, then leave this blank.",
                "items": {
                  "type": "integer",
                  "description": "Alert trigger type ID (can be found in trigger_type.go)"
                }
              },
              "action_types": {
                "type": "array",
                "minItems": 1,
                "description": "List of alert actions that if triggered, would count as usage. If alerts are not involved in usage, then leave this blank.",
                "items": {
                  "type": "integer",
                  "description": "Action type ID (can be found in action_types.go)"
                }
              }
            },
            "additionalProperties": false
          },
          "mobile_logs_event_types": {
            "type": "array",
            "minItems": 1,
            "description": "List of mobile event types that if visited from the Driver App/Mobile App, would count as usage. If mobile logs are not involved in usage, then leave this blank.",
            "items": {
              "type": "string",
              "description": "Mobile logs event type"
            }
          },
          "api_endpoints": {
            "type": "array",
            "minItems": 1,
            "description": "List of API endpoints that if hit, would count as usage. If API logging is not involved in usage, then leave this blank.",
            "items": {
              "type": "object",
              "description": "API object consists of method + route",
              "properties": {
                "method": {
                  "type": "string",
                  "description": "API method (e.g. GET, POST)",
                  "enum": ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD"]
                },
                "route": {
                  "type": "string",
                  "description": "API route (e.g. /v1/users)"
                }
              }
            },
            "additionalProperties": false,
            "required": ["method", "route"]
          },
          "custom_query": {
            "type": "object",
            "description": "If your usage condition doesn't meet any of the above, this template will cover custom SQL queries.",
            "properties": {
              "sql_file": {
                "type": "string",
                "pattern": ".*.sql$",
                "description": "SQL file name (SQL files should exist within this directory). Query should return date, org_id, and user_id (if applicable)."
              },
              "eu_sql_file": {
                "type": "string",
                "pattern": ".*.sql$",
                "description": "SQL file name (SQL files should exist within this directory) for EU usage. Query should return date, org_id, and user_id (if applicable). To find out how to convert a US query to EU, follow this guide: https://samsara.atlassian-us-gov-mod.net/wiki/spaces/DATA/pages/17850487/How+To+Finding+EU+S3+Locations+In+Databricks."
              },
              "filter_internal_usage": {
                "type": "boolean",
                "description": "Whether internal usage should be filtered out or not. This assumes a user_id field exists in the query."
              },
              "has_user_id_field": {
                "type": "boolean",
                "description": "Whether the query has a user_id field or not."
              },
              "usage_field": {
                "type": "string",
                "description": "Name of field in usage query that quantifies usage (coaching_session_id, for example). If unspecified, a count(*) is done for usage (as opposed to a count(distinct usage_field)."
              },
              "binary_query": {
                "type": "boolean",
                "description": "Set to true if we should count usage based on something being turned on. Essentially, instead of counting all actions between a week ago and today for weekly usage, we instead count on whether something was turned on."
              },
              "date_filter": {
                "type": "boolean",
                "default": true,
                "description": "Assumed to be true, but set to false if a date filter doesn't make sense in the context of the query (usually used with binary_query)"
              },
              "operation": {
                "type": "string",
                "description": "Operation to perform on usage_field (assumes usage_field is specified). Possible values are COUNT, SUM.",
                "enum": ["COUNT", "SUM"],
                "default": "COUNT"
              }
            },
            "additionalProperties": false,
            "required": ["sql_file", "eu_sql_file", "filter_internal_usage", "has_user_id_field"],
            "if": {
              "properties": {
                "filter_internal_usage": { "const": true }
              },
              "required": ["filter_internal_usage"]
            },
            "then": {
              "properties": {
                "has_user_id_field": { "const": true }
              },
              "required": ["has_user_id_field"]
            },
            "allOf": [
              {
                "if": {
                  "properties": {
                    "operation": { "type": "string" }
                  },
                  "not": {
                    "properties": {
                      "binary_query": { "const": true }
                    }
                  }
                },
                "then": {
                  "required": ["usage_field"]
                }
              }
            ]
          },
          "effective_date": {
            "type": "string",
            "format": "date",
            "description": "The date when this feature usage configuration becomes effective"
          }
        },
        "additionalProperties": false,
        "required": ["effective_date"],
        "oneOf": [
          {
            "properties": {
              "custom_query": { "type": "object" }
            },
            "required": ["custom_query"],
            "not": {
              "anyOf": [
                { "required": ["route_names"] },
                { "required": ["mixpanel_metric_names"] },
                { "required": ["alerts"] },
                { "required": ["mobile_logs_event_types"] },
                { "required": ["api_endpoints"] }
              ]
            }
          },
          {
            "properties": {
              "alerts": { "type": "object" }
            },
            "required": ["alerts"],
            "not": {
              "anyOf": [
                { "required": ["route_names"] },
                { "required": ["mixpanel_metric_names"] },
                { "required": ["custom_query"] },
                { "required": ["mobile_logs_event_types"] },
                { "required": ["api_endpoints"] }
              ]
            }
          },
          {
            "properties": {
              "api_endpoints": { "type": "array" }
            },
            "required": ["api_endpoints"],
            "not": {
              "anyOf": [
                { "required": ["route_names"] },
                { "required": ["mixpanel_metric_names"] },
                { "required": ["custom_query"] },
                { "required": ["mobile_logs_event_types"] },
                { "required": ["alerts"] }
              ]
            }
          },
          {
            "properties": {
              "mobile_logs_event_types": { "type": "array" }
            },
            "required": ["mobile_logs_event_types"],
            "not": {
              "anyOf": [
                { "required": ["route_names"] },
                { "required": ["mixpanel_metric_names"] },
                { "required": ["custom_query"] },
                { "required": ["alerts"] },
                { "required": ["api_endpoints"] }
              ]
            }
          },
          {
            "anyOf": [{ "required": ["route_names"] }, { "required": ["mixpanel_metric_names"] }],
            "not": {
              "anyOf": [
                { "required": ["alerts"] },
                { "required": ["custom_query"] },
                { "required": ["mobile_logs_event_types"] },
                { "required": ["api_endpoints"] }
              ]
            }
          },
          {
            "allOf": [
              {
                "not": {
                  "anyOf": [
                    { "required": ["custom_query"] },
                    { "required": ["alerts"] },
                    { "required": ["mobile_logs_event_types"] },
                    { "required": ["api_endpoints"] }
                  ]
                }
              },
              {
                "not": {
                  "anyOf": [{ "required": ["route_names"] }, { "required": ["mixpanel_metric_names"] }]
                }
              }
            ]
          }
        ]
      }
    },
    "user_eligibility_array": {
      "type": "array",
      "minItems": 1,
      "description": "Array on a feature's evolving user eligibility details. For features that have existed for a long time, only the latest details are needed.",
      "items": {
        "type": "object",
        "properties": {
          "serves_all_users": {
            "type": "boolean",
            "default": false,
            "description": "Whether all authenticated users can access this feature. When true, no other fields besides effective_date should be set."
          },
          "actions": {
            "type": "array",
            "minItems": 1,
            "description": "Actions that give a user access to the feature. Action names can be found in authzaction.go.",
            "items": {
              "type": "string",
              "description": "User action"
            }
          },
          "action_logic": {
            "type": "string",
            "description": "Determines if a user needs all actions (AND) or just any one action (OR) to have access to the feature.",
            "enum": ["AND", "OR"],
            "default": "AND"
          },
          "tag_roles_supported": {
            "type": "boolean",
            "description": "Whether tag-scoped roles can access this feature. If false, only org-level roles have access."
          },
          "effective_date": {
            "type": "string",
            "format": "date",
            "description": "The date when this user eligibility configuration becomes effective"
          }
        },
        "required": ["effective_date"],
        "additionalProperties": false,
        "oneOf": [
          {
            "properties": {
              "serves_all_users": { "const": true }
            },
            "required": ["serves_all_users"],
            "not": {
              "anyOf": [
                { "required": ["actions"] },
                { "required": ["action_logic"] },
                { "required": ["tag_roles_supported"] }
              ]
            }
          },
          {
            "required": ["actions", "action_logic", "tag_roles_supported"],
            "not": {
              "required": ["serves_all_users"],
              "properties": {
                "serves_all_users": { "const": true }
              }
            }
          }
        ]
      }
    }
  },
  "required": ["feature_name", "enablement_array", "usage_array"],
  "additionalProperties": false
}
