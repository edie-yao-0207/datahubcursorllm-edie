from dagster import AssetExecutionContext, DailyPartitionsDefinition
from dataweb import (
    NonEmptyDQCheck,
    NonNullDQCheck,
    PrimaryKeyDQCheck,
    TrendDQCheck,
    table,
)
from dataweb.userpkgs.constants import (
    DATAENGINEERING,
    FRESHNESS_SLO_9AM_PST,
    AWSRegion,
    ColumnDescription,
    Database,
    TableType,
    WarehouseWriteMode,
)
from dataweb.userpkgs.utils import (
    build_table_description,
    partition_keys_from_context,
)

PRIMARY_KEYS = ["date", "org_id", "driver_id"]

SCHEMA = [
    {
        "name": "date",
        "type": "string",
        "nullable": False,
        "metadata": {
            "comment": ColumnDescription.DATE,
        },
    },
    {
        "name": "org_id",
        "type": "long",
        "nullable": False,
        "metadata": {
            "comment": ColumnDescription.ORG_ID,
        },
    },
    {
        "name": "driver_id",
        "type": "long",
        "nullable": False,
        "metadata": {
            "comment": ColumnDescription.DRIVER_ID,
        },
    },
    {
        "name": "last_trip_date",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_count_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_count_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_count_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_distance_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_distance_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "camera_trip_distance_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_count_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_count_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_count_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_distance_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_distance_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "outward_only_facing_camera_trip_distance_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_count_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_count_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_count_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_distance_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_distance_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dual_facing_camera_trip_distance_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_duration_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_duration_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_duration_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_distance_miles_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_distance_miles_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_distance_miles_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "max_speed_kmph_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "max_speed_kmph_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "max_speed_kmph_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "over_speed_limit_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "over_speed_limit_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "over_speed_limit_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_ratio_over_limit_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_ratio_over_limit_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_ratio_over_limit_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "light_speeding_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "moderate_speeding_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "heavy_speeding_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_mins_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_mins_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_mins_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_ratio_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_ratio_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "severe_speeding_ratio_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_in_morning_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_in_morning_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_in_morning_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_at_night_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_at_night_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_at_night_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_below_freezing_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_below_freezing_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_below_freezing_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_over_35_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_over_35_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_count_over_35_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "crashes_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "crashes_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "crashes_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "following_distance_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "following_distance_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "following_distance_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "mobile_usage_violations_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "mobile_usage_violations_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "mobile_usage_violations_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_braking_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_braking_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_braking_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_turns_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_turns_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_turns_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "no_seatbelt_violations_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "no_seatbelt_violations_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "no_seatbelt_violations_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "distracted_driving_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "distracted_driving_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "distracted_driving_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "rolling_stop_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "rolling_stop_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "rolling_stop_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_accelerations_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_accelerations_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "harsh_accelerations_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "drowsiness_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "drowsiness_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "drowsiness_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "lane_departure_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "lane_departure_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "lane_departure_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "hos_violation_count_1d",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "hos_violation_count_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "hos_violation_count_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "total_events_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "total_events_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "total_events_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "coached_events_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "coached_events_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "coached_events_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "virtual_coaching_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "virtual_coaching_30d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "virtual_coaching_60d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_rural_driving_environment_locations_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_rural_driving_environment_locations_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_rural_driving_environment_locations_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_urban_driving_environment_locations_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_urban_driving_environment_locations_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_urban_driving_environment_locations_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_mixed_driving_environment_locations_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_mixed_driving_environment_locations_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_mixed_driving_environment_locations_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_living_street_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_living_street_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_living_street_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_motorway_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_motorway_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_motorway_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_primary_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_primary_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_primary_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_residential_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_residential_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_residential_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_secondary_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_secondary_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_secondary_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_service_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_service_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_service_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_tertiary_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_tertiary_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_tertiary_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_trunk_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_trunk_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_trunk_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_unclassified_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_unclassified_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_unclassified_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_null_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_null_30d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "proportion_roadway_null_60d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "is_eld_relevant_device",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "primary_vehicle_model",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "primary_vehicle_make",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "primary_max_weight_lbs",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "primary_gross_vehicle_weight_rating",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "max_trip_end_time_ms_1d",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dayofweek_sin_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dayofweek_cos_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dayofyear_sin_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "dayofyear_cos_1d",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "account_cs_tier",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "account_size_segment",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "account_arr_segment",
        "type": "string",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "n_org_vg_devices",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "n_org_cm_devices",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_next_1_day",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_next_7_days",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "mobile_usage_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "mobile_usage_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "seatbelt_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "seatbelt_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "inattentive_driving_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "inattentive_driving_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "drowsiness_detection_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "drowsiness_detection_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "rolling_stop_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "in_cab_stop_sign_violation_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "forward_collision_warning_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "forward_collision_warning_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "following_distance_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "following_distance_audio_alerts_enabled_org",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "driver_tenure_days",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_duration_weighted",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "max_speed_weighted",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "speeding_ratio_weighted",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "trip_ended_at_night_weighted",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "total_events_weighted",
        "type": "double",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_prev_1_year",
        "type": "long",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "has_org_30d_coaching_history",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "has_org_30d_virtual_coaching_history",
        "type": "integer",
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_next_1_day_source",
        "type": {"type": "array", "elementType": "string"},
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_next_7_days_source",
        "type": {"type": "array", "elementType": "string"},
        "nullable": False,
        "metadata": {},
    },
    {
        "name": "labelled_crash_count_prev_1_year_source",
       "type": {"type": "array", "elementType": "string"},
        "nullable": False,
        "metadata": {},
    },
]

QUERY = """
SELECT
    date,
    org_id,
    driver_id,
    last_trip_date,
    trip_count_1d,
    trip_count_30d,
    trip_count_60d,
    camera_trip_count_1d,
    camera_trip_count_30d,
    camera_trip_count_60d,
    camera_trip_ratio_1d,
    camera_trip_ratio_30d,
    camera_trip_ratio_60d,
    camera_trip_distance_ratio_1d,
    camera_trip_distance_ratio_30d,
    camera_trip_distance_ratio_60d,
    outward_only_facing_camera_trip_count_1d,
    outward_only_facing_camera_trip_count_30d,
    outward_only_facing_camera_trip_count_60d,
    outward_only_facing_camera_trip_ratio_1d,
    outward_only_facing_camera_trip_ratio_30d,
    outward_only_facing_camera_trip_ratio_60d,
    outward_only_facing_camera_trip_distance_ratio_1d,
    outward_only_facing_camera_trip_distance_ratio_30d,
    outward_only_facing_camera_trip_distance_ratio_60d,
    dual_facing_camera_trip_count_1d,
    dual_facing_camera_trip_count_30d,
    dual_facing_camera_trip_count_60d,
    dual_facing_camera_trip_ratio_1d,
    dual_facing_camera_trip_ratio_30d,
    dual_facing_camera_trip_ratio_60d,
    dual_facing_camera_trip_distance_ratio_1d,
    dual_facing_camera_trip_distance_ratio_30d,
    dual_facing_camera_trip_distance_ratio_60d,
    trip_duration_mins_1d,
    trip_duration_mins_30d,
    trip_duration_mins_60d,
    trip_distance_miles_1d,
    trip_distance_miles_30d,
    trip_distance_miles_60d,
    max_speed_kmph_1d,
    max_speed_kmph_30d,
    max_speed_kmph_60d,
    over_speed_limit_mins_1d,
    over_speed_limit_mins_30d,
    over_speed_limit_mins_60d,
    speeding_ratio_over_limit_1d,
    speeding_ratio_over_limit_30d,
    speeding_ratio_over_limit_60d,
    light_speeding_mins_1d,
    light_speeding_mins_30d,
    light_speeding_mins_60d,
    light_speeding_ratio_1d,
    light_speeding_ratio_30d,
    light_speeding_ratio_60d,
    moderate_speeding_mins_1d,
    moderate_speeding_mins_30d,
    moderate_speeding_mins_60d,
    moderate_speeding_ratio_1d,
    moderate_speeding_ratio_30d,
    moderate_speeding_ratio_60d,
    heavy_speeding_mins_1d,
    heavy_speeding_mins_30d,
    heavy_speeding_mins_60d,
    heavy_speeding_ratio_1d,
    heavy_speeding_ratio_30d,
    heavy_speeding_ratio_60d,
    severe_speeding_mins_1d,
    severe_speeding_mins_30d,
    severe_speeding_mins_60d,
    severe_speeding_ratio_1d,
    severe_speeding_ratio_30d,
    severe_speeding_ratio_60d,
    trip_ended_in_morning_1d,
    trip_ended_in_morning_30d,
    trip_ended_in_morning_60d,
    trip_ended_at_night_1d,
    trip_ended_at_night_30d,
    trip_ended_at_night_60d,
    trip_count_below_freezing_1d,
    trip_count_below_freezing_30d,
    trip_count_below_freezing_60d,
    trip_count_over_35_1d,
    trip_count_over_35_30d,
    trip_count_over_35_60d,
    crashes_1d,
    crashes_30d,
    crashes_60d,
    speeding_1d,
    speeding_30d,
    speeding_60d,
    CASE WHEN COALESCE(following_distance_enabled_org, FALSE) = FALSE THEN -1 ELSE following_distance_1d END as following_distance_1d,
    CASE WHEN COALESCE(following_distance_enabled_org, FALSE) = FALSE THEN -1 ELSE following_distance_30d END as following_distance_30d,
    CASE WHEN COALESCE(following_distance_enabled_org, FALSE) = FALSE THEN -1 ELSE following_distance_60d END as following_distance_60d,
    CASE WHEN COALESCE(mobile_usage_enabled_org, FALSE) = FALSE THEN -1 ELSE mobile_usage_violations_1d END as mobile_usage_violations_1d,
    CASE WHEN COALESCE(mobile_usage_enabled_org, FALSE) = FALSE THEN -1 ELSE mobile_usage_violations_30d END as mobile_usage_violations_30d,
    CASE WHEN COALESCE(mobile_usage_enabled_org, FALSE) = FALSE THEN -1 ELSE mobile_usage_violations_60d END as mobile_usage_violations_60d,
    harsh_braking_1d,
    harsh_braking_30d,
    harsh_braking_60d,
    harsh_turns_1d,
    harsh_turns_30d,
    harsh_turns_60d,
    CASE WHEN COALESCE(seatbelt_enabled_org, FALSE) = FALSE THEN -1 ELSE no_seatbelt_violations_1d END as no_seatbelt_violations_1d,
    CASE WHEN COALESCE(seatbelt_enabled_org, FALSE) = FALSE THEN -1 ELSE no_seatbelt_violations_30d END as no_seatbelt_violations_30d,
    CASE WHEN COALESCE(seatbelt_enabled_org, FALSE) = FALSE THEN -1 ELSE no_seatbelt_violations_60d END as no_seatbelt_violations_60d,
    CASE WHEN COALESCE(inattentive_driving_enabled_org, FALSE) = FALSE THEN -1 ELSE distracted_driving_1d END as distracted_driving_1d,
    CASE WHEN COALESCE(inattentive_driving_enabled_org, FALSE) = FALSE THEN -1 ELSE distracted_driving_30d END as distracted_driving_30d,
    CASE WHEN COALESCE(inattentive_driving_enabled_org, FALSE) = FALSE THEN -1 ELSE distracted_driving_60d END as distracted_driving_60d,
    CASE WHEN COALESCE(rolling_stop_enabled_org, FALSE) = FALSE THEN -1 ELSE rolling_stop_1d END as rolling_stop_1d,
    CASE WHEN COALESCE(rolling_stop_enabled_org, FALSE) = FALSE THEN -1 ELSE rolling_stop_30d END as rolling_stop_30d,
    CASE WHEN COALESCE(rolling_stop_enabled_org, FALSE) = FALSE THEN -1 ELSE rolling_stop_60d END as rolling_stop_60d,
    harsh_accelerations_1d,
    harsh_accelerations_30d,
    harsh_accelerations_60d,
    CASE WHEN COALESCE(drowsiness_detection_enabled_org, FALSE) = FALSE THEN -1 ELSE drowsiness_1d END as drowsiness_1d,
    CASE WHEN COALESCE(drowsiness_detection_enabled_org, FALSE) = FALSE THEN -1 ELSE drowsiness_30d END as drowsiness_30d,
    CASE WHEN COALESCE(drowsiness_detection_enabled_org, FALSE) = FALSE THEN -1 ELSE drowsiness_60d END as drowsiness_60d,
    lane_departure_1d,
    lane_departure_30d,
    lane_departure_60d,
    CASE WHEN COALESCE(is_eld_relevant_device, 0) = 1 THEN hos_violation_count_1d ELSE -1 END as hos_violation_count_1d,
    CASE WHEN COALESCE(is_eld_relevant_device, 0) = 1 THEN hos_violation_count_30d ELSE -1 END as hos_violation_count_30d,
    CASE WHEN COALESCE(is_eld_relevant_device, 0) = 1 THEN hos_violation_count_60d ELSE -1 END as hos_violation_count_60d,
    total_events_1d,
    total_events_30d,
    total_events_60d,
    CASE WHEN org_30d_coaching_history > 0 THEN coached_events_1d ELSE -1 END as coached_events_1d,
    CASE WHEN org_30d_coaching_history > 0 THEN coached_events_30d ELSE -1 END as coached_events_30d,
    CASE WHEN org_30d_coaching_history > 0 THEN coached_events_60d ELSE -1 END as coached_events_60d,
    CASE WHEN org_30d_virtual_coaching_history > 0 THEN virtual_coaching_1d ELSE -1 END as virtual_coaching_1d,
    CASE WHEN org_30d_virtual_coaching_history > 0 THEN virtual_coaching_30d ELSE -1 END as virtual_coaching_30d,
    CASE WHEN org_30d_virtual_coaching_history > 0 THEN virtual_coaching_60d ELSE -1 END as virtual_coaching_60d,
    proportion_rural_driving_environment_locations_1d,
    proportion_rural_driving_environment_locations_30d,
    proportion_rural_driving_environment_locations_60d,
    proportion_urban_driving_environment_locations_1d,
    proportion_urban_driving_environment_locations_30d,
    proportion_urban_driving_environment_locations_60d,
    proportion_mixed_driving_environment_locations_1d,
    proportion_mixed_driving_environment_locations_30d,
    proportion_mixed_driving_environment_locations_60d,
    proportion_roadway_living_street_1d,
    proportion_roadway_living_street_30d,
    proportion_roadway_living_street_60d,
    proportion_roadway_motorway_1d,
    proportion_roadway_motorway_30d,
    proportion_roadway_motorway_60d,
    proportion_roadway_primary_1d,
    proportion_roadway_primary_30d,
    proportion_roadway_primary_60d,
    proportion_roadway_residential_1d,
    proportion_roadway_residential_30d,
    proportion_roadway_residential_60d,
    proportion_roadway_secondary_1d,
    proportion_roadway_secondary_30d,
    proportion_roadway_secondary_60d,
    proportion_roadway_service_1d,
    proportion_roadway_service_30d,
    proportion_roadway_service_60d,
    proportion_roadway_tertiary_1d,
    proportion_roadway_tertiary_30d,
    proportion_roadway_tertiary_60d,
    proportion_roadway_trunk_1d,
    proportion_roadway_trunk_30d,
    proportion_roadway_trunk_60d,
    proportion_roadway_unclassified_1d,
    proportion_roadway_unclassified_30d,
    proportion_roadway_unclassified_60d,
    proportion_roadway_null_1d,
    proportion_roadway_null_30d,
    proportion_roadway_null_60d,
    is_eld_relevant_device,
    primary_vehicle_model,
    primary_vehicle_make,
    primary_max_weight_lbs,
    primary_gross_vehicle_weight_rating,
    max_trip_end_time_ms_1d,
    dayofweek_sin_1d,
    dayofweek_cos_1d,
    CAST(-1 AS double) as dayofyear_sin_1d,
    CAST(-1 AS double) as dayofyear_cos_1d,
    account_cs_tier,
    account_size_segment,
    account_arr_segment,
    n_org_vg_devices,
    n_org_cm_devices,
    labelled_crash_count_next_1_day,
    labelled_crash_count_next_7_days,
    CASE WHEN mobile_usage_enabled_org = TRUE THEN 1 ELSE 0 END as mobile_usage_enabled_org,
    CASE WHEN mobile_usage_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as mobile_usage_audio_alerts_enabled_org,
    CASE WHEN seatbelt_enabled_org = TRUE THEN 1 ELSE 0 END as seatbelt_enabled_org,
    CASE WHEN seatbelt_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as seatbelt_audio_alerts_enabled_org,
    CASE WHEN inattentive_driving_enabled_org = TRUE THEN 1 ELSE 0 END as inattentive_driving_enabled_org,
    CASE WHEN inattentive_driving_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as inattentive_driving_audio_alerts_enabled_org,
    CASE WHEN drowsiness_detection_enabled_org = TRUE THEN 1 ELSE 0 END as drowsiness_detection_enabled_org,
    CASE WHEN drowsiness_detection_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as drowsiness_detection_audio_alerts_enabled_org,
    CASE WHEN rolling_stop_enabled_org = TRUE THEN 1 ELSE 0 END as rolling_stop_enabled_org,
    CASE WHEN in_cab_stop_sign_violation_enabled_org = TRUE THEN 1 ELSE 0 END as in_cab_stop_sign_violation_enabled_org,
    CASE WHEN forward_collision_warning_enabled_org = TRUE THEN 1 ELSE 0 END as forward_collision_warning_enabled_org,
    CASE WHEN forward_collision_warning_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as forward_collision_warning_audio_alerts_enabled_org,
    CASE WHEN following_distance_enabled_org = TRUE THEN 1 ELSE 0 END as following_distance_enabled_org,
    CASE WHEN following_distance_audio_alerts_enabled_org = TRUE THEN 1 ELSE 0 END as following_distance_audio_alerts_enabled_org,
    driver_tenure_days,
    (trip_duration_mins_1d * 1e0) + (trip_duration_mins_30d * 5e-1) + (trip_duration_mins_60d * 2.5e-1) AS trip_duration_weighted,
    (max_speed_kmph_1d * 1e0) + (max_speed_kmph_30d * 5e-1) + (max_speed_kmph_60d * 2.5e-1) AS max_speed_weighted,
    (speeding_ratio_over_limit_1d * 1e0) + (speeding_ratio_over_limit_30d * 5e-1) + (speeding_ratio_over_limit_60d * 2.5e-1) AS speeding_ratio_weighted,
    (trip_ended_at_night_1d * 1e0) + (trip_ended_at_night_30d * 5e-1) + (trip_ended_at_night_60d * 2.5e-1) AS trip_ended_at_night_weighted,
    (total_events_1d * 1e0) + (total_events_30d * 5e-1) + (total_events_60d * 2.5e-1) AS total_events_weighted,
    labelled_crash_count_prev_1_year,
    CASE WHEN org_30d_coaching_history > 0 THEN 1 ELSE 0 END as has_org_30d_coaching_history,
    CASE WHEN org_30d_virtual_coaching_history > 0 THEN 1 ELSE 0 END as has_org_30d_virtual_coaching_history,
    labelled_crash_count_next_1_day_source,
    labelled_crash_count_next_7_days_source,
    labelled_crash_count_prev_1_year_source
FROM product_analytics.dim_driver_features
WHERE date BETWEEN {PARTITION_START} AND {PARTITION_END}
"""


@table(
    database=Database.FEATURE_STORE,
    description=build_table_description(
        table_desc="""Driver risk insights features extracted from dim_driver_features table.""",
        row_meaning="""Each row represents aggregated driver features for risk insights analysis.""",
        related_table_info={},
        table_type=TableType.DAILY_DIMENSION,
        freshness_slo_updated_by=FRESHNESS_SLO_9AM_PST,
    ),
    regions=[AWSRegion.US_WEST_2],
    owners=[DATAENGINEERING],
    schema=SCHEMA,
    primary_keys=PRIMARY_KEYS,
    partitioning=DailyPartitionsDefinition(start_date="2023-09-01"),
    write_mode=WarehouseWriteMode.OVERWRITE,
    max_retries=3,
    dq_checks=[
        NonEmptyDQCheck(name="dq_non_empty_driver_risk_insights_features"),
        PrimaryKeyDQCheck(name="dq_pk_driver_risk_insights_features", primary_keys=PRIMARY_KEYS),
        NonNullDQCheck(
            name="dq_non_null_driver_risk_insights_features",
            non_null_columns=PRIMARY_KEYS,
        ),
    ],
    backfill_batch_size=3,
    upstreams=["product_analytics.dim_driver_features"],
)
def driver_risk_insights_features(context: AssetExecutionContext) -> str:
    context.log.info("Updating driver_risk_insights_features")
    partition_keys = partition_keys_from_context(context)[0]
    context.log.info(str(partition_keys))

    PARTITION_START = partition_keys[0]
    PARTITION_END = partition_keys[-1]

    query = QUERY.format(
        PARTITION_START=PARTITION_START,
        PARTITION_END=PARTITION_END,
    )
    context.log.info(f"{query}")
    return query
