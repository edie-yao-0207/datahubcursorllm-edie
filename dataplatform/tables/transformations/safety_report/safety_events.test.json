{
  "test_cases": [
    {
      "label": "returns two valid safety events",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 456
          },
          {
            "organization_id": 123
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        },
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 222
        }
      ]
    },
    {
      "label": "filters out org_id = 1 and org_id = 562949953421343",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 1,
            "device_id": 1,
            "event_ms": 1641350792000,
            "trip_start_ms": 1641343592000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 562949953421343,
            "device_id": 1,
            "event_ms": 1641350792000,
            "trip_start_ms": 1641343592000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 333
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 1,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 562949953421343,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 1,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 562949953421343,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 1
          },
          {
            "organization_id": 562949953421343
          },
          {
            "organization_id": 123
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 333
        }
      ]
    },
    {
      "label": "filters out events under 5mph",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 1
              },
              "stop": {
                "speed_milliknots": 1
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 123
          },
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        }
      ]
    },
    {
      "label": "does not filter out crash events under 5mph",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 1
              },
              "stop": {
                "speed_milliknots": 1
              },
              "accel_type": 5,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 123
          },
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        },
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 222
        }
      ]
    },

    {
      "label": "filters out events where trip ended outside of parameter date range",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1640927100000,
            "release_stage": 4,
            "date": "2021-12-31",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1640927100000,
            "date": "2021-12-31",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2021-12-31",
            "start_ms": 1640926800000,
            "end_ms": 1640930400000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 123
          },
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        }
      ]
    },
    {
      "label": "reads driver_id from trips2db.driver_id_exclude_0_drivers",
      "parameters": {
        "start_date": " '2022-01-04' ",
        "end_date": " '2022-01-07' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id": 2,
            "driver_id_exclude_0_drivers": 3,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 3,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        }
      ]
    },
    {
      "label": "filters out trip with a non-101 version id",
      "parameters": {
        "start_date": " '2022-01-04' ",
        "end_date": " '2022-01-07' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 3,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 100,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": -1
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 3,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        }
      ]
    },
    {
      "label": "returns four valid safety events in different coaching states",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792001,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792002,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 333
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792003,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 444
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792001,
            "date": "2022-01-05",
            "coaching_state": 2
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792002,
            "date": "2022-01-05",
            "coaching_state": 3
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792003,
            "date": "2022-01-05",
            "coaching_state": 9
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 123
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        },
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 1,
          "in_triage_states": 0,
          "event_ms": 1641350792001,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 222
        },
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 1,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 0,
          "event_ms": 1641350792002,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 333
        },
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 1,
          "in_coaching_states": 0,
          "in_triage_states": 0,
          "event_ms": 1641350792003,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 444
        }
      ]
    },
    {
      "label": "returns expected release stage value for safety events",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 0,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 456
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 1,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111
        }
      ]
    },
    {
      "label": "Returns one safety event with triage_uuid and the other with null triage uuid",
      "parameters": {
        "start_date": " '2022-01-01' ",
        "end_date": " '2022-02-01' "
      },
      "input_data": {
        "safetydb_shards.safety_events": [
          {
            "org_id": 456,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 111
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          },
          {
            "org_id": 123,
            "device_id": 1,
            "trip_start_ms": 1641343592000,
            "event_ms": 1641350792000,
            "release_stage": 4,
            "date": "2022-01-05",
            "detail_proto": {
              "start": {
                "speed_milliknots": 5000
              },
              "stop": {
                "speed_milliknots": 5000
              },
              "accel_type": 2,
              "event_id": 222
            },
            "additional_labels": {
              "additional_labels": [
                {
                  "label_type": 17,
                  "label_source": 1,
                  "last_added_ms": 1641350792000
                }
              ]
            }
          }
        ],
        "safetydb_shards.safety_event_metadata": [
          {
            "org_id": 456,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          },
          {
            "org_id": 123,
            "device_id": 1,
            "event_ms": 1641350792000,
            "date": "2022-01-05",
            "coaching_state": 1
          }
        ],
        "trips2db_shards.trips": [
          {
            "org_id": 456,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          },
          {
            "org_id": 123,
            "device_id": 1,
            "driver_id_exclude_0_drivers": 1,
            "date": "2022-01-05",
            "start_ms": 1641343592000,
            "end_ms": 1641361592000,
            "version": 101
          }
        ],
        "clouddb.groups": [
          {
            "organization_id": 456
          },
          {
            "organization_id": 123
          }
        ],
        "safetyeventtriagedb_shards.triage_events_v2": [
          {
            "org_id": 456,
            "uuid": "te1",
            "version": 1,
            "device_id": 1,
            "driver_id": 1,
            "start_ms": 1641350792000,
            "end_ms": 1641343593000,
            "trip_start_ms": 1641343592000,
            "source_event_uuid": "se1",
            "trigger_label": 32,
            "behavior_labels": [],
            "release_stage": 4,
            "triage_state": 1,
            "is_dismissed": 0,
            "coach_id": 1,
            "coaching_state": "COACHED",
            "priority": 1,
            "created_at_ms": 1641343593000,
            "updated_at_ms": 1641343593000,
            "behavior_labels_blob": "[]",
            "date": "2022-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 456,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 111,
          "triage_uuid": "te1",
          "triage_version": 2
        },
        {
          "org_id": 123,
          "device_id": 1,
          "driver_id": 1,
          "trip_start_ms": 1641343592000,
          "trip_end_ms": 1641361592000,
          "trip_version": 101,
          "additional_labels": [
            {
              "label_type": 17,
              "label_source": 1,
              "last_added_ms": 1641350792000
            }
          ],
          "in_dismissed_states": 0,
          "in_recognition_states": 0,
          "in_coaching_states": 0,
          "in_triage_states": 1,
          "event_ms": 1641350792000,
          "release_stage": 100,
          "date": "2022-01-05",
          "label_type": 17,
          "label_source": 1,
          "event_id": 222,
          "triage_uuid": null,
          "triage_version": null
        }
      ]
    }
  ]
}
