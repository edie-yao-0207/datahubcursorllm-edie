{
  "test_cases": [
    {
      "label": "no recording intervals if auxcam never associated with a VG",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1606694400001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-09-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400003,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400004,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609545600005,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-01-02"
          }
        ]
      },
      "expected_data": []
    },
    {
      "label": "no recording intervals if dashcam state has only erroring intervals ",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1606694400001,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-09-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400003,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400004,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609545600005,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-01-02"
          }
        ]
      },
      "expected_data": []
    },
    {
      "label": "only data in the [start_date, end_date) interval is included",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1606694400001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-09-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400003,
            "value": {
              "int_value": 6,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400004,
            "value": {
              "int_value": 7,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400005,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609545600006,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-01-02"
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 10,
          "auxcam_id": 101,
          "date": "2021-10-30",
          "start_ms": 1609286400003,
          "end_ms": 1609286400005
        }
      ]
    },
    {
      "label": "if the first data object stat within interval is recording, no rounding to the beginning of the queried range",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          }
        ]
      },
      "expected_data": [
        {
          "auxcam_id": 101,
          "date": "2021-10-29",
          "org_id": 10,
          "start_ms": 1609200000001,
          "end_ms": 1609286400002
        }
      ]
    },
    {
      "label": "if the last data object stat within interval is recording, no rounding to the end of the queried range",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400002,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          }
        ]
      },
      "expected_data": [
        {
          "auxcam_id": 101,
          "date": "2021-10-30",
          "org_id": 10,
          "start_ms": 1609286400002,
          "end_ms": 1609286460002
        }
      ]
    },
    {
      "label": "if the only object stat in range is recording, only assume a minute worth of recording after",
      "parameters": {
        "start_date": " '2021-10-29' ",
        "end_date": " '2021-11-02' ",
        "pipeline_execution_time": " '2021-11-01 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          }
        ]
      },
      "expected_data": [
        {
          "auxcam_id": 101,
          "date": "2021-10-29",
          "org_id": 10,
          "start_ms": 1609200000001,
          "end_ms": 1609200060001
        }
      ]
    },
    {
      "label": "Recording stats before the start date are not included",
      "parameters": {
        "start_date": " '2021-10-30' ",
        "end_date": " '2021-11-30' ",
        "pipeline_execution_time": " '2021-11-30 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1635206400001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-26"
          }
        ]
      },
      "expected_data": []
    },
    {
      "label": "if most recent object stat is recording, assume intervals ends a minute after",
      "parameters": {
        "start_date": " '2021-10-29' ",
        "end_date": " '2021-11-02' ",
        "pipeline_execution_time": " '2021-11-01 12:00:00' "
      },
      "input_data": {
        "deviceassociationsdb_shards.device_collection_associations": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 126
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200060001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200120001,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          }
        ]
      },
      "expected_data": [
        {
          "auxcam_id": 101,
          "date": "2021-10-29",
          "org_id": 10,
          "start_ms": 1609200000001,
          "end_ms": 1609200180001
        }
      ]
    }
  ]
}
