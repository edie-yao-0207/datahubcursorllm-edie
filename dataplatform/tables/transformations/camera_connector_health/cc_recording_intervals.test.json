{
  "test_cases": [
    {
      "label": "only data in the [start_date, end_date) interval is included",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "productsdb.devices": [
          {
            "org_id": 10,
            "id": 100,
            "product_id": 24,
            "camera_serial": "ran-domSeri-al"
          }
        ],
        "productsdb.gateways": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 43,
            "serial": "random-Serial"
          }
        ],
        "kinesisstats.osdrearcameraframestate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1606694400001,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-09-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400003,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400004,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609545600005,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-01-02"
          }
        ]
      },
      "expected_data": [
        {
          "cm_id": 101,
          "date": "2021-10-30",
          "org_id": 10,
          "start_ms": 1609286400003,
          "end_ms": 1609286400004,
          "vg_id": 100
        }
      ]
    },
    {
      "label": "if the first data object stat within interval is recording, computed interval starts at query start date",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "productsdb.devices": [
          {
            "org_id": 10,
            "id": 100,
            "product_id": 24,
            "camera_serial": "ran-domSeri-al"
          }
        ],
        "productsdb.gateways": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 43,
            "serial": "random-Serial"
          }
        ],
        "kinesisstats.osdrearcameraframestate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400002,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          }
        ]
      },
      "expected_data": [
        {
          "cm_id": 101,
          "date": "2021-10-29",
          "org_id": 10,
          "start_ms": 1635206400000,
          "end_ms": 1609286400002,
          "vg_id": 100
        }
      ]
    },
    {
      "label": "if the last data object stat within interval is recording, computed interval ends at query end date",
      "parameters": {
        "start_date": " '2021-10-26' ",
        "end_date": " '2021-11-01' ",
        "pipeline_execution_time": " '2021-11-02 12:00:00' "
      },
      "input_data": {
        "productsdb.devices": [
          {
            "org_id": 10,
            "id": 100,
            "product_id": 24,
            "camera_serial": "ran-domSeri-al"
          }
        ],
        "productsdb.gateways": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 43,
            "serial": "random-Serial"
          }
        ],
        "kinesisstats.osdrearcameraframestate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609200000001,
            "value": {
              "int_value": 0,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-29"
          },
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1609286400002,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-30"
          }
        ]
      },
      "expected_data": [
        {
          "cm_id": 101,
          "date": "2021-10-30",
          "org_id": 10,
          "start_ms": 1609286400002,
          "end_ms": 1635854400000,
          "vg_id": 100
        }
      ]
    },
    {
      "label": "if the last data object stat within past week before interval is recording, recording interval is entire range",
      "parameters": {
        "start_date": " '2021-10-30' ",
        "end_date": " '2021-11-02' ",
        "pipeline_execution_time": " '2021-11-01 12:00:00' "
      },
      "input_data": {
        "productsdb.devices": [
          {
            "org_id": 10,
            "id": 100,
            "product_id": 24,
            "camera_serial": "ran-domSeri-al"
          }
        ],
        "productsdb.gateways": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 43,
            "serial": "random-Serial"
          }
        ],
        "kinesisstats.osdrearcameraframestate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1635206400001,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-26"
          }
        ]
      },
      "expected_data": [
        {
          "cm_id": 101,
          "date": "2021-10-30",
          "org_id": 10,
          "start_ms": 1635552000000,
          "end_ms": 1635768000000,
          "vg_id": 100
        }
      ]
    },
    {
      "label": "Even a month long backfill will include recording stats within 5 days of the start date",
      "parameters": {
        "start_date": " '2021-10-30' ",
        "end_date": " '2021-11-30' ",
        "pipeline_execution_time": " '2021-11-30 12:00:00' "
      },
      "input_data": {
        "productsdb.devices": [
          {
            "org_id": 10,
            "id": 100,
            "product_id": 24,
            "camera_serial": "ran-domSeri-al"
          }
        ],
        "productsdb.gateways": [
          {
            "org_id": 10,
            "device_id": 101,
            "product_id": 43,
            "serial": "random-Serial"
          }
        ],
        "kinesisstats.osdrearcameraframestate": [
          {
            "org_id": 10,
            "object_id": 101,
            "time": 1635206400001,
            "value": {
              "int_value": 2,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2021-10-26"
          }
        ]
      },
      "expected_data": [
        {
          "cm_id": 101,
          "date": "2021-10-30",
          "org_id": 10,
          "start_ms": 1635552000000,
          "end_ms": 1638273600000,
          "vg_id": 100
        }
      ]
    }
  ]
}
