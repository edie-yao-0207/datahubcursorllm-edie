{
  "test_cases": [
    {
      "label": "multiple location points in a given engine interval, the first location is selected",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "kinesisstats.location": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1010,
            "value": {
              "revgeo_state": "WA"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1000,
            "value": {
              "revgeo_state": "OR"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1300,
            "value": {
              "revgeo_state": "AL"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 101,
            "time": 1300,
            "value": {
              "revgeo_state": "AZ"
            }
          }
        ],
        "engine_state_report.engine_state_driver_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 900,
            "end_ms": 1200,
            "engine_state": "ON",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "avg_air_temp_c": 15,
            "driver_id": 101
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 1200,
            "end_ms": 1500,
            "engine_state": "IDLE",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 200,
            "gaseous_fuel_consumed_grams": 200,
            "avg_air_temp_c": 24,
            "driver_id": 102
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 101,
            "start_ms": 1200,
            "end_ms": 1500,
            "engine_state": "IDLE",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 205,
            "gaseous_fuel_consumed_grams": 205,
            "avg_air_temp_c": 9999,
            "driver_id": 0
          }
        ]
      },
      "expected_data": [
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 900,
          "end_ms": 1200,
          "engine_state": 1,
          "pto_state": 0,
          "fuel_consumed_ml": 100,
          "gaseous_fuel_consumed_grams": 100,
          "starting_state": "OR",
          "driver_id": 101,
          "avg_air_temp_c": 15
        },
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 1200,
          "end_ms": 1500,
          "engine_state": 2,
          "pto_state": 0,
          "fuel_consumed_ml": 200,
          "gaseous_fuel_consumed_grams": 200,
          "starting_state": "AL",
          "driver_id": 102,
          "avg_air_temp_c": 24
        },
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 101,
          "start_ms": 1200,
          "end_ms": 1500,
          "engine_state": 2,
          "pto_state": 0,
          "fuel_consumed_ml": 205,
          "gaseous_fuel_consumed_grams": 205,
          "starting_state": "AZ",
          "driver_id": 0,
          "avg_air_temp_c": 9999
        }
      ]
    },
    {
      "label": "if no location exists in an engine interval, use the last location. Location point at end_ms does not count as overlapping",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "kinesisstats.location": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1000,
            "value": {
              "revgeo_state": "WA"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1500,
            "value": {
              "revgeo_state": "GA"
            }
          }
        ],
        "engine_state_report.engine_state_driver_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 900,
            "end_ms": 1200,
            "engine_state": "ON",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "avg_air_temp_c": 26,
            "driver_id": 101
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 1200,
            "end_ms": 1500,
            "engine_state": "IDLE",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 200,
            "gaseous_fuel_consumed_grams": 200,
            "avg_air_temp_c": 9999,
            "driver_id": 102
          }
        ]
      },
      "expected_data": [
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 900,
          "end_ms": 1200,
          "engine_state": 1,
          "pto_state": 0,
          "fuel_consumed_ml": 100,
          "gaseous_fuel_consumed_grams": 100,
          "starting_state": "WA",
          "driver_id": 101,
          "avg_air_temp_c": 26
        },
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 1200,
          "end_ms": 1500,
          "engine_state": 2,
          "pto_state": 0,
          "fuel_consumed_ml": 200,
          "gaseous_fuel_consumed_grams": 200,
          "starting_state": "WA",
          "driver_id": 102,
          "avg_air_temp_c": 9999
        }
      ]
    },
    {
      "label": "location proto is properly parsed",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "kinesisstats.location": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1000,
            "value": {
              "latitude": -12.5,
              "longitude": 48.6,
              "revgeo_house_number": 8675309,
              "revgeo_neighborhood": "Samsara Woods",
              "revgeo_street": "Grove Street",
              "revgeo_city": "Enumclaw",
              "revgeo_state": "WA",
              "revgeo_country": "US",
              "revgeo_postcode": 1017
            }
          }
        ],
        "engine_state_report.engine_state_driver_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 900,
            "end_ms": 1200,
            "engine_state": "ON",
            "productive_pto_state": 1,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "avg_air_temp_c": 15,
            "driver_id": 101
          }
        ]
      },
      "expected_data": [
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 900,
          "end_ms": 1200,
          "engine_state": 1,
          "pto_state": 1,
          "fuel_consumed_ml": 100,
          "gaseous_fuel_consumed_grams": 100,
          "starting_latitude": -12.5,
          "starting_longitude": 48.6,
          "starting_house_number": 8675309,
          "starting_neighborhood": "Samsara Woods",
          "starting_street": "Grove Street",
          "starting_city": "Enumclaw",
          "starting_state": "WA",
          "starting_country": "US",
          "starting_post_code": 1017,
          "driver_id": 101,
          "avg_air_temp_c": 15
        }
      ]
    },
    {
      "label": "engine interval does not have location point, and previous engine interval has multiple locations. First interval uses first location, and next interval uses last location",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "kinesisstats.location": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1000,
            "value": {
              "revgeo_state": "WA"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1005,
            "value": {
              "revgeo_state": "HI"
            }
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1010,
            "value": {
              "revgeo_state": "OR"
            }
          }
        ],
        "engine_state_report.engine_state_driver_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 900,
            "end_ms": 1100,
            "engine_state": "ON",
            "productive_pto_state": 0,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "avg_air_temp_c": 26,
            "driver_id": 101
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 1100,
            "end_ms": 1600,
            "engine_state": "IDLE",
            "productive_pto_state": 1,
            "fuel_consumed_ml": 200,
            "gaseous_fuel_consumed_grams": 200,
            "avg_air_temp_c": 21,
            "driver_id": 102
          }
        ]
      },
      "expected_data": [
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 900,
          "end_ms": 1100,
          "engine_state": 1,
          "pto_state": 0,
          "fuel_consumed_ml": 100,
          "gaseous_fuel_consumed_grams": 100,
          "starting_state": "WA",
          "driver_id": 101,
          "avg_air_temp_c": 26
        },
        {
          "date": "2022-01-01",
          "org_id": 1,
          "object_type": 1,
          "object_id": 100,
          "start_ms": 1100,
          "end_ms": 1600,
          "engine_state": 2,
          "pto_state": 1,
          "fuel_consumed_ml": 200,
          "gaseous_fuel_consumed_grams": 200,
          "starting_state": "OR",
          "driver_id": 102,
          "avg_air_temp_c": 21
        }
      ]
    },
    {
      "label": "OFF interval is dropped",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "kinesisstats.location": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "time": 1000,
            "value": {
              "latitude": -12.5,
              "longitude": 48.6,
              "revgeo_house_number": 8675309,
              "revgeo_neighborhood": "Samsara Woods",
              "revgeo_street": "Grove Street",
              "revgeo_city": "Enumclaw",
              "revgeo_state": "WA",
              "revgeo_country": "US",
              "revgeo_postcode": 1017
            }
          }
        ],
        "engine_state_report.engine_state_driver_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 900,
            "end_ms": 1200,
            "engine_state": "OFF",
            "productive_pto_state": 1,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "avg_air_temp_c": 15,
            "driver_id": 101
          }
        ]
      },
      "expected_data": []
    }
  ]
}
