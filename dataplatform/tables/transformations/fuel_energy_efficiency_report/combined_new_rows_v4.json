{
  "name": "fuel_energy_efficiency_report.combined_new_rows_v4",
  "owner": "Sustainability",
  "description": "Note that node is only valid from when we started computing V4/can only be valid from when canonical fuel types was complete (around the start of 2024). This table is the result of a number of joined tables and coalesces their rows into a single row for each driver/vehicle/hour combination. This is for FEER v4, which updates where fuel costs are taken from and moves emissions computation into the pipeline.",
  "tags": ["telematics", "fuel", "ev"],
  "dependencies": [
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "engine_state_fuel_by_hour_v3",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "energy_consumption_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "distance_by_hour_v3",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "electric_distance_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "regen_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "org_fuel_energy_cost_and_emissions_hour_intervals",
      "type": "table"
    },
    {
      "external": true,
      "dbname": "helpers",
      "tablename": "unit_conversion",
      "type": "table"
    },
    {
      "dbname": "fueldb_shards",
      "tablename": "fuel_types",
      "type": "table",
      "external": true
    }
  ],
  "parameters": ["start_date", "end_date"],
  "backfill_start_date": "2024-11-13",
  "output": {
    "dbname": "fuel_energy_efficiency_report",
    "tablename": "combined_new_rows_v4",
    "type": "table",
    "partition": ["date"],
    "write_mode": "overwrite",
    "primary_key": ["date", "org_id", "object_id", "driver_id", "interval_start"],
    "schema": [
      {
        "name": "date",
        "type": "date",
        "metadata": {
          "comment": "The date of this hour of aggregated data."
        }
      },
      {
        "name": "org_id",
        "type": "long",
        "metadata": {
          "comment": "$org_id_default_description"
        }
      },
      {
        "name": "object_id",
        "type": "long",
        "metadata": {
          "comment": "The driver or vehicle id of this hour of aggregated data."
        }
      },
      {
        "name": "driver_id",
        "type": "long",
        "nullable": false,
        "metadata": {
          "comment": "The driver id of this hour of aggregated data."
        }
      },
      {
        "name": "interval_start",
        "type": "timestamp",
        "metadata": {
          "comment": "The starting timestamp of this hourly interval."
        }
      },
      {
        "name": "interval_end",
        "type": "timestamp",
        "metadata": {
          "comment": "The ending timestamp of this hourly interval."
        }
      },
      {
        "name": "engine_type",
        "type": "integer",
        "nullable": false,
        "metadata": {
          "comment": "The engine type (ICE, Hybrid, PHEV, BEV) of the vehicle for this hourly interval."
        }
      },
      {
        "name": "configurable_fuel_id",
        "type": "integer",
        "nullable": false,
        "metadata": {
          "comment": "The configurable fuel type (Gasoline, Diesel, Biodiesel, Ethanol or Electricity) of the vehicle for this hourly interval."
        }
      },
      {
        "name": "fuel_consumed_ml",
        "type": "long",
        "metadata": {
          "comment": "The amount of fuel consumed in milliliters for this hour of aggregated data. This is derived from the fuel_consumption_by_hour table."
        }
      },
      {
        "name": "fuel_consumed_ml_as_gaseous_type",
        "type": "long",
        "nullable": true,
        "metadata": {
          "comment": "The amount of fuel consumed in milliliters for this hour of aggregated data where the vehicle was of gaseous fuel type. This is derived from the fuel_consumption_by_hour table."
        }
      },
      {
        "name": "gaseous_fuel_consumed_grams",
        "type": "long",
        "metadata": {
          "comment": "The amount of gaseous fuel consumed in grams for this hour of aggregated data. This is derived from the engine_state_fuel_by_hour table."
        }
      },
      {
        "name": "energy_consumed_kwh",
        "type": "decimal(38,9)",
        "metadata": {
          "comment": "The amount of energy consumed in kilowatt-hours for this hour of aggregated data. This is derived from the energy_consumption_by_hour table"
        }
      },
      {
        "name": "on_duration_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that the engine was on during this hour. This is derived from the engine_duration_by_hour table."
        }
      },
      {
        "name": "idle_duration_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that the engine was idle during this hour. This is derived from the engine_duration_by_hour table."
        }
      },
      {
        "name": "aux_during_idle_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that auxillary power was being used during idle time in this hour. This is often referred to as productive idle time or PTO (power take-off). This is derived from the aux_engine_state_duration_by_hour table."
        }
      },
      {
        "name": "electric_distance_traveled_m",
        "type": "double",
        "metadata": {
          "comment": "The distance in meters that was traveled via electricity in this hour. This is derived from the electric_distance_by_hour table."
        }
      },
      {
        "name": "energy_regen_kwh",
        "type": "decimal(38,9)",
        "metadata": {
          "comment": "The amount of energy regenerated in kilowatt-hours during this hour. This usually happens via regenerative braking. This is derived from the regen_by_hour table."
        }
      },
      {
        "name": "fuel_cost",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The cost in US dollars of the fuel consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel costs in the custom_fuel_cost_emissions table and defaults to the gasoline factor if there is no more specific override."
        }
      },
      {
        "name": "fuel_ml_cost_as_gaseous_type",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The cost in US dollars of the fuel consumed ml in this hour of aggregated data where the vehicle was of gaseous fuel type. This cost is derived from an org's custom entered fuel costs in the custom_fuel_cost_emissions table and defaults to the gasoline factor if there is no more specific override."
        }
      },
      {
        "name": "energy_cost",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The cost in US dollars of the energy consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel costs in the custom_fuel_cost_emissions table and defaults to dynamically fetched values in locale_fuel_costs when there are no custom overrides."
        }
      },
      {
        "name": "gaseous_fuel_cost",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The cost in US dollars of the gaseous fuel consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel costs in the custom_fuel_cost_emissions table and defaults to dynamically fetched values in locale_fuel_costs when there are no custom overrides."
        }
      },
      {
        "name": "fuel_emissions",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The emissions in grams of CO2 due to the amount of fuel consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel/energy emissions factors in the custom_fuel_cost_emissions table and the default emissions factors defined globally."
        }
      },
      {
        "name": "fuel_ml_emissions_as_gaseous_type",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The emissions in grams of CO2 due to the amount of fuel consumed in this hour of aggregated data where the vehicle was of gaseous fuel type. This cost is derived from an org's custom entered fuel/energy emissions factors in the custom_fuel_cost_emissions table and the default emissions factors defined globally."
        }
      },
      {
        "name": "energy_emissions",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The emissions in grams of CO2 due to the amount energy consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel/energy emissions factors in the custom_fuel_cost_emissions table, defaulting to 0 if no custom override is set."
        }
      },
      {
        "name": "gaseous_fuel_emissions",
        "type": "double",
        "nullable": true,
        "metadata": {
          "comment": "The emissions in grams of CO2 due to the amount gaseous fuel consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel/energy emissions factors in the custom_fuel_cost_emissions table, defaulting to 0 if no custom override is set."
        }
      },
      {
        "name": "distance_traveled_m",
        "type": "double",
        "metadata": {
          "comment": "The distance traveled in meters for this hour of aggregated data. This is derived from the distance_by_hour table, which ultimate derives from canonical_distance.total_distance."
        }
      }
    ]
  }
}
