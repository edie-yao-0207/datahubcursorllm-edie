{
  "name": "fuel_energy_efficiency_report.combined_new_rows_v3",
  "owner": "Sustainability",
  "description": "This table is the result of a number of joined tables and coalesces their rows into a single row for each driver/vehicle/hour combination. This is for FEER v3, which filters out distance and fuel that overlap with spotty ECU segments.",
  "tags": ["telematics", "fuel", "ev"],
  "dependencies": [
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "engine_state_fuel_by_hour_v3",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "energy_consumption_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "distance_by_hour_v3",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "electric_distance_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "regen_by_hour",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "custom_fuel_unit_cost_interval",
      "type": "table"
    },
    {
      "dbname": "fuel_energy_efficiency_report",
      "tablename": "dynamic_fuel_cost_hour_intervals",
      "type": "table"
    },
    {
      "external": true,
      "dbname": "fueldb_shards",
      "tablename": "fuel_types",
      "type": "table"
    },
    {
      "external": true,
      "dbname": "helpers",
      "tablename": "unit_conversion",
      "type": "table"
    }
  ],
  "expectation": {
    "batch_mode": "KEEP_ALL"
  },
  "parameters": ["start_date", "end_date"],
  "disabled_regions": ["eu-west-1", "us-west-2", "ca-central-1"],
  "output": {
    "dbname": "fuel_energy_efficiency_report",
    "tablename": "combined_new_rows_v3",
    "type": "table",
    "partition": ["date"],
    "write_mode": "overwrite",
    "primary_key": ["date", "org_id", "object_id", "driver_id", "interval_start"],
    "schema": [
      {
        "name": "date",
        "type": "date",
        "metadata": {
          "comment": "The date of this hour of aggregated data."
        }
      },
      {
        "name": "org_id",
        "type": "long",
        "metadata": {
          "comment": "$org_id_default_description"
        }
      },
      {
        "name": "object_id",
        "type": "long",
        "metadata": {
          "comment": "The driver or vehicle id of this hour of aggregated data."
        }
      },
      {
        "name": "driver_id",
        "type": "long",
        "nullable": false,
        "metadata": {
          "comment": "The driver id of this hour of aggregated data."
        }
      },
      {
        "name": "interval_start",
        "type": "timestamp",
        "metadata": {
          "comment": "The starting timestamp of this hourly interval."
        }
      },
      {
        "name": "interval_end",
        "type": "timestamp",
        "metadata": {
          "comment": "The ending timestamp of this hourly interval."
        }
      },
      {
        "name": "fuel_consumed_ml",
        "type": "long",
        "metadata": {
          "comment": "The amount of fuel consumed in milliliters for this hour of aggregated data. This is derived from the fuel_consumption_by_hour table."
        }
      },
      {
        "name": "energy_consumed_kwh",
        "type": "decimal(38,9)",
        "metadata": {
          "comment": "The amount of energy consumed in kilowatt-hours for this hour of aggregated data. This is derived from the energy_consumption_by_hour table"
        }
      },
      {
        "name": "custom_energy_cost",
        "type": "integer",
        "nullable": false,
        "metadata": {
          "comment": "The total estimated cost in US dollars of the energy consumed in this hour of aggregated data. This is currently 0 as org's do not have the ability yet to set custom energy costs."
        }
      },
      {
        "name": "dynamic_energy_cost",
        "type": "decimal(38,11)",
        "metadata": {
          "comment": "The total estimated cost in US dollars of the energy consumed in this hour of aggregated data. This is derived from a constant cost per kilowatt-hour from helpers.unit_conversion, multiplied by values from the energy_consumption_by_hour table."
        }
      },
      {
        "name": "on_duration_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that the engine was on during this hour. This is derived from the engine_duration_by_hour table."
        }
      },
      {
        "name": "idle_duration_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that the engine was idle during this hour. This is derived from the engine_duration_by_hour table."
        }
      },
      {
        "name": "aux_during_idle_ms",
        "type": "long",
        "metadata": {
          "comment": "The duration in milliseconds that auxillary power was being used during idle time in this hour. This is often referred to as productive idle time or PTO (power take-off). This is derived from the aux_engine_state_duration_by_hour table."
        }
      },
      {
        "name": "electric_distance_traveled_m",
        "type": "double",
        "metadata": {
          "comment": "The distance in meters that was traveled via electricity in this hour. This is derived from the electric_distance_by_hour table."
        }
      },
      {
        "name": "energy_regen_kwh",
        "type": "decimal(38,9)",
        "metadata": {
          "comment": "The amount of energy regenerated in kilowatt-hours during this hour. This usually happens via regenerative braking. This is derived from the regen_by_hour table."
        }
      },
      {
        "name": "custom_fuel_cost",
        "type": "double",
        "metadata": {
          "comment": "The total cost in US dollars of the fuel consumed in this hour of aggregated data. This cost is derived from an org's custom entered fuel costs in the custom_fuel_unit_cost_interval table."
        }
      },
      {
        "name": "dynamic_fuel_cost",
        "type": "double",
        "metadata": {
          "comment": "The total cost in US dollars of the fuel consumed in this hour of aggregated data. This cost is derived from a value pulled from a fuel price API stored in the dynamic_fuel_cost_hour_intervals table."
        }
      },
      {
        "name": "distance_traveled_m",
        "type": "double",
        "metadata": {
          "comment": "The distance traveled in meters for this hour of aggregated data. This is derived from the distance_by_hour table, which ultimate derives from canonical_distance.total_distance."
        }
      }
    ]
  }
}
