{
  "test_cases": [
    {
      "label": "fuel segment overlaps with two spotty ECU intervals, do not duplicate fuel row, and 0 out fuel consumed",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "fuel_energy_efficiency_report.ecu_filter_segments": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "segment_start": 1641021000000,
            "segment_end": 1641021600000,
            "pct_bad_ecu": 0.95
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "segment_start": 1641021600000,
            "segment_end": 1641022200000,
            "pct_bad_ecu": 0.9
          }
        ],
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 1641019800000,
            "end_ms": 1641022200000,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "productive_pto_state": 1,
            "engine_state": "IDLE"
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 1,
          "date": "2022-01-01",
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2022-01-01 06:00:00",
          "interval_end": "2022-01-01 07:00:00",
          "on_duration_ms": 600000,
          "idle_duration_ms": 600000,
          "aux_during_idle_ms": 600000,
          "fuel_consumed_ml": 0,
          "gaseous_fuel_consumed_grams": 0
        },
        {
          "org_id": 1,
          "date": "2022-01-01",
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2022-01-01 07:00:00",
          "interval_end": "2022-01-01 08:00:00",
          "on_duration_ms": 1800000,
          "idle_duration_ms": 1800000,
          "aux_during_idle_ms": 1800000,
          "fuel_consumed_ml": 0,
          "gaseous_fuel_consumed_grams": 0
        }
      ]
    },
    {
      "label": "fuel segments join with spotty ECU intervals properly when different devices are present",
      "parameters": {
        "start_date": "'2022-01-01'",
        "end_date": "'2022-01-04'"
      },
      "input_data": {
        "fuel_energy_efficiency_report.ecu_filter_segments": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 100,
            "segment_start": 1641021000000,
            "segment_end": 1641021600000,
            "pct_bad_ecu": 0.8
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "device_id": 101,
            "segment_start": 1641021600000,
            "segment_end": 1641022200000,
            "pct_bad_ecu": 0.9
          }
        ],
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 100,
            "start_ms": 1641021120000,
            "end_ms": 1641021480000,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "productive_pto_state": 0,
            "engine_state": "IDLE"
          },
          {
            "date": "2022-01-01",
            "org_id": 1,
            "object_id": 102,
            "start_ms": 1641021120000,
            "end_ms": 1641021480000,
            "fuel_consumed_ml": 205,
            "gaseous_fuel_consumed_grams": 205,
            "productive_pto_state": 0,
            "engine_state": "ON"
          }
        ]
      },
      "expected_data": [
        {
          "org_id": 1,
          "date": "2022-01-01",
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2022-01-01 07:00:00",
          "interval_end": "2022-01-01 08:00:00",
          "on_duration_ms": 360000,
          "idle_duration_ms": 360000,
          "aux_during_idle_ms": 0,
          "fuel_consumed_ml": 0,
          "gaseous_fuel_consumed_grams": 0
        },
        {
          "org_id": 1,
          "date": "2022-01-01",
          "object_id": 102,
          "driver_id": 0,
          "interval_start": "2022-01-01 07:00:00",
          "interval_end": "2022-01-01 08:00:00",
          "on_duration_ms": 360000,
          "idle_duration_ms": 0,
          "aux_during_idle_ms": 0,
          "fuel_consumed_ml": 205,
          "gaseous_fuel_consumed_grams": 205
        }
      ]
    },
    {
      "label": "split IDLE, ON, and AUX time between multiple hours and drivers",
      "parameters": {
        "start_date": "'2021-08-25'",
        "end_date": "'2021-08-28'"
      },
      "input_data": {
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629882900000,
            "end_ms": 1629886500000,
            "fuel_consumed_ml": 95,
            "gaseous_fuel_consumed_grams": 95,
            "productive_pto_state": 0,
            "engine_state": "ON"
          },
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629886500000,
            "end_ms": 1629890100000,
            "fuel_consumed_ml": 100,
            "gaseous_fuel_consumed_grams": 100,
            "productive_pto_state": 1,
            "engine_state": "IDLE"
          },
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629890100000,
            "end_ms": 1629891900000,
            "fuel_consumed_ml": 105,
            "gaseous_fuel_consumed_grams": 105,
            "productive_pto_state": 0,
            "engine_state": "IDLE"
          }
        ],
        "fuel_energy_efficiency_report.driver_assignments": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "device_id": 100,
            "driver_id": 1009,
            "start_time": 1629889200000,
            "end_time": 1629925200000
          },
          {
            "org_id": 1,
            "date": "2021-08-25",
            "device_id": 100,
            "driver_id": 1004,
            "start_time": 1629882000000,
            "end_time": 1629889200000
          }
        ]
      },
      "expected_data": [
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 1004,
          "interval_start": "2021-08-25 09:00:00",
          "interval_end": "2021-08-25 10:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 2700000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 71,
          "gaseous_fuel_consumed_grams": 71
        },
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 1004,
          "interval_start": "2021-08-25 10:00:00",
          "interval_end": "2021-08-25 11:00:00",
          "aux_during_idle_ms": 2700000,
          "on_duration_ms": 3600000,
          "idle_duration_ms": 2700000,
          "fuel_consumed_ml": 98,
          "gaseous_fuel_consumed_grams": 98
        },
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 1009,
          "interval_start": "2021-08-25 11:00:00",
          "interval_end": "2021-08-25 12:00:00",
          "aux_during_idle_ms": 900000,
          "on_duration_ms": 2700000,
          "idle_duration_ms": 2700000,
          "fuel_consumed_ml": 130,
          "gaseous_fuel_consumed_grams": 130
        }
      ]
    },
    {
      "label": "distribute a fuel interval across a driver assignments + no driver assignment",
      "parameters": {
        "start_date": "'2021-08-25'",
        "end_date": "'2021-08-28'"
      },
      "input_data": {
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629882900000,
            "end_ms": 1629890100000,
            "fuel_consumed_ml": 1000,
            "gaseous_fuel_consumed_grams": 1000,
            "productive_pto_state": 0,
            "engine_state": "ON"
          }
        ],
        "fuel_energy_efficiency_report.driver_assignments": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "device_id": 100,
            "driver_id": 1004,
            "start_time": 1629871200000,
            "end_time": 1629885600000
          }
        ]
      },
      "expected_data": [
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 1004,
          "interval_start": "2021-08-25 09:00:00",
          "interval_end": "2021-08-25 10:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 2700000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 375,
          "gaseous_fuel_consumed_grams": 375
        },
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2021-08-25 10:00:00",
          "interval_end": "2021-08-25 11:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 3600000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 500,
          "gaseous_fuel_consumed_grams": 500
        },
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2021-08-25 11:00:00",
          "interval_end": "2021-08-25 12:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 900000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 125,
          "gaseous_fuel_consumed_grams": 125
        }
      ]
    },
    {
      "label": "distribute a fuel interval across a driver assignments. Hour intervals that cover a driver assignment and a non-assigned period are only assigned to the driver. This is a quirk of the logic that was in the monolith as well, but its unlikely a driver assignment changes while the vehicle is in motion, so this shouldn't be an issue.",
      "parameters": {
        "start_date": "'2021-08-25'",
        "end_date": "'2021-08-28'"
      },
      "input_data": {
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629882900000,
            "end_ms": 1629884700000,
            "fuel_consumed_ml": 1000,
            "gaseous_fuel_consumed_grams": 1000,
            "productive_pto_state": 0,
            "engine_state": "ON"
          }
        ],
        "fuel_energy_efficiency_report.driver_assignments": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "device_id": 100,
            "driver_id": 1004,
            "start_time": 1629871200000,
            "end_time": 1629883800000
          }
        ]
      },
      "expected_data": [
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 1004,
          "interval_start": "2021-08-25 09:00:00",
          "interval_end": "2021-08-25 10:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 900000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 1000,
          "gaseous_fuel_consumed_grams": 1000
        }
      ]
    },
    {
      "label": "distribute a fuel interval, but it is > 100 gallons consumed in an hour, so zero out the fuel since it is most likely bad data",
      "parameters": {
        "start_date": "'2021-08-25'",
        "end_date": "'2021-08-28'"
      },
      "input_data": {
        "engine_state_report.engine_state_pto_fuel_intervals": [
          {
            "org_id": 1,
            "date": "2021-08-25",
            "object_id": 100,
            "start_ms": 1629882900000,
            "end_ms": 1629884700000,
            "fuel_consumed_ml": 454610,
            "gaseous_fuel_consumed_grams": 300000,
            "productive_pto_state": 0,
            "engine_state": "ON"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2021-08-25",
          "org_id": 1,
          "object_id": 100,
          "driver_id": 0,
          "interval_start": "2021-08-25 09:00:00",
          "interval_end": "2021-08-25 10:00:00",
          "aux_during_idle_ms": 0,
          "on_duration_ms": 1800000,
          "idle_duration_ms": 0,
          "fuel_consumed_ml": 0,
          "gaseous_fuel_consumed_grams": 0
        }
      ]
    }
  ]
}
