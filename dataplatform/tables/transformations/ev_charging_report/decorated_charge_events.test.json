{
  "test_cases": [
    {
      "label": "test one charge event with no location stats and no end soc",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": []
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": null,
          "energy_charged_kwh": 10,
          "address": null,
          "latitude": null,
          "longitude": null
        }
      ]
    },
    {
      "label": "test one charge event no location stats",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": []
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 10,
          "address": null,
          "latitude": null,
          "longitude": null
        }
      ]
    },
    {
      "label": "test one charge event with energy charged stats outside of event period",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 1500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 4000000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": null,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test one charge event all stats exists with ideal timings",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 10,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test multiple non-overlapping charge events from one device all stats exists with ideal timings",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          },
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 4000000,
            "end_ms": 6000000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 3900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 95000, "is_databreak": false, "is_end": false },
            "time": 6400000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 5800000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 3800000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 10,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        },
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 4000000,
          "end_ms": 6000000,
          "start_soc": 80,
          "end_soc": 95,
          "energy_charged_kwh": 20,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test multiple overlapping charge event from different devices all stats exists with ideal timings",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          },
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 2,
            "start_ms": 1200000,
            "end_ms": 2700000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "value": { "int_value": 0, "is_databreak": false, "is_end": false },
            "time": 600000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "value": { "int_value": 55000, "is_databreak": false, "is_end": false },
            "time": 3000000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3500000,
            "date": "2020-01-05"
          },

          {
            "org_id": 1,
            "object_id": 2,
            "value": { "int_value": 30000000000, "is_databreak": false, "is_end": false },
            "time": 2500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "device_id": 2,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1000000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 10,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        },
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 2,
          "start_ms": 1200000,
          "end_ms": 2700000,
          "start_soc": 0,
          "end_soc": 55,
          "energy_charged_kwh": 30,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test one charge event with energy charged stats outside of event period but within 90s of the end - so they are included",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 4500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 2000000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3645000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 20,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test two charge events, the first event with energy charged stats outside of event period but within 300s of the end of the session - so they are included. However energy charged stats are not double counted.",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          },
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 3900000,
            "end_ms": 9000000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 3700000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 85000, "is_databreak": false, "is_end": false },
            "time": 9500000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 2000000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3899999,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 3900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 10000000000, "is_databreak": false, "is_end": false },
            "time": 7200000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.location": [
          {
            "org_id": 1,
            "device_id": 1,
            "value": {
              "latitude": 51.513504784683974,
              "longitude": -0.07276554232918843,
              "revgeo_city": "London",
              "revgeo_street": "Alie Street",
              "revgeo_state": "England",
              "revgeo_postcode": "E1 8DE"
            },
            "time": 1500000,
            "date": "2020-01-05"
          }
        ]
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80,
          "energy_charged_kwh": 20,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        },
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 3900000,
          "end_ms": 9000000,
          "start_soc": 80,
          "end_soc": 85,
          "energy_charged_kwh": 20,
          "address": "Alie Street London, England E1 8DE",
          "latitude": 51.513504784683974,
          "longitude": -0.07276554232918843
        }
      ]
    },
    {
      "label": "test one charge event where there is no soc reported after the event, so we take the max in soc within the event as the end soc",
      "parameters": {
        "start_date": " '2020-01-01' ",
        "end_date": " '2020-01-10' "
      },
      "input_data": {
        "ev_charging_report.charge_events": [
          {
            "date": "2020-01-05",
            "org_id": 1,
            "object_id": 1,
            "start_ms": 1800000,
            "end_ms": 3600000
          }
        ],
        "kinesisstats.osdevusablestateofchargemillipercent": [
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 50000, "is_databreak": false, "is_end": false },
            "time": 900000,
            "date": "2020-01-05"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "value": { "int_value": 80000, "is_databreak": false, "is_end": false },
            "time": 3000000,
            "date": "2020-01-05"
          }
        ],
        "kinesisstats.osddeltaevchargingenergymicrowh": [],
        "kinesisstats.location": []
      },
      "expected_data": [
        {
          "date": "2020-01-05",
          "org_id": 1,
          "device_id": 1,
          "start_ms": 1800000,
          "end_ms": 3600000,
          "start_soc": 50,
          "end_soc": 80
        }
      ]
    }
  ]
}
