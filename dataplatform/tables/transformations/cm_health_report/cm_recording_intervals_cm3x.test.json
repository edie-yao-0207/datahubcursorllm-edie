{
  "test_cases": [
    {
      "label": "If we are recording during off recording_expected, recording_expected will be false",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 1,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": 1,
            "vg_product_id": 24,
            "cm_product_id": 43,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": false
          }
        ],
        "cm_health_report.cm_physically_disconnected_intervals": [
          {
            "org_id": 1,
            "device_id": 1,
            "linked_cm_id": 1,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "date": "2022-02-15"
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947425234,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947425239,
            "value": {
              "int_value": 3,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": 1,
          "vg_product_id": 24,
          "cm_product_id": 43,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 0,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": false,
          "grace_recording_duration_ms": 0,
          "recording_duration_ms": 0,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we are recording during a recording_expected, we should return the recording_expected as recording time.",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 1,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": null,
            "vg_product_id": 24,
            "cm_product_id": 43,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": true
          }
        ],
        "cm_health_report.cm_physically_disconnected_intervals": [
          {
            "org_id": 1,
            "device_id": 1,
            "linked_cm_id": 1,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "date": "2022-02-15"
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947425234,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947425239,
            "value": {
              "int_value": 3,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": null,
          "vg_product_id": 24,
          "cm_product_id": 43,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 4,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": true,
          "grace_recording_duration_ms": 0,
          "recording_duration_ms": 0,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we are recording during a trip for a Brigid CM, we should return the trip as recording time.",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 155,
            "product_id": 24,
            "vg_device_id": 1,
            "linked_cm_id": 2,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": 2,
            "vg_product_id": 24,
            "cm_product_id": 155,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": true
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947425234,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947425239,
            "value": {
              "int_value": 3,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": 2,
          "vg_product_id": 24,
          "cm_product_id": 155,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 4,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": true,
          "grace_recording_duration_ms": 4,
          "recording_duration_ms": 4,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we are recording with data only or to buffer only during a trip for a Brigid CM, we should return the trip as recording time.",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 155,
            "product_id": 24,
            "vg_device_id": 1,
            "linked_cm_id": 2,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": 2,
            "vg_product_id": 24,
            "cm_product_id": 155,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": true
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947425200,
            "value": {
              "int_value": 6,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947425210,
            "value": {
              "int_value": 7,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 2,
            "time": 1644947425239,
            "value": {
              "int_value": 3,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": 2,
          "vg_product_id": 24,
          "cm_product_id": 155,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 4,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": true,
          "grace_recording_duration_ms": 4,
          "recording_duration_ms": 4,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we have no good object stats, recording time is 0",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 1,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": null,
            "vg_product_id": 24,
            "cm_product_id": 43,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": false
          }
        ],
        "cm_health_report.cm_physically_disconnected_intervals": [
          {
            "org_id": 1,
            "device_id": 1,
            "linked_cm_id": 1,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "date": "2022-02-15"
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": true,
              "is_end": true,
              "is_start": true
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": null,
          "vg_product_id": 24,
          "cm_product_id": 43,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 4,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": false,
          "grace_recording_duration_ms": 0,
          "recording_duration_ms": 0,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we have no cm_target_intervals, we have no output",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 1,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": true,
              "is_end": true,
              "is_start": true
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": []
    },
    {
      "label": "If cm is different from object stat, recording time is 0",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 2,
            "id": 2,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 2,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 2,
            "vg_device_id": 2,
            "cm_device_id": null,
            "vg_product_id": 24,
            "cm_product_id": 43,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": false
          }
        ],
        "cm_health_report.cm_physically_disconnected_intervals": [
          {
            "org_id": 2,
            "device_id": 2,
            "linked_cm_id": 2,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "date": "2022-02-15"
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": true,
              "is_end": true,
              "is_start": true
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 2,
          "cm_device_id": null,
          "vg_product_id": 24,
          "cm_product_id": 43,
          "date": "2022-02-15",
          "org_id": 2,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 4,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": false,
          "grace_recording_duration_ms": 0,
          "recording_duration_ms": 0,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    },
    {
      "label": "If we started recording but have not received a stat indicating an end of recording for Cm3x, use the latest object stat as end_ms",
      "parameters": {
        "start_date": " '2022-02-14' ",
        "end_date": " '2022-02-22' ",
        "pipeline_execution_time": " '2022-02-22 11:00:00' "
      },
      "input_data": {
        "cm_health_report.cm_2x_3x_linked_vgs": [
          {
            "org_id": 1,
            "id": 1,
            "cm_product_id": 43,
            "product_id": 24,
            "vg_device_id": 1,
            "upper_camera_serial": "RANDOMSERIAL",
            "camera_fist_connected_at": 1
          }
        ],
        "cm_health_report.cm_target_intervals": [
          {
            "org_id": 1,
            "vg_device_id": 1,
            "cm_device_id": 1,
            "vg_product_id": 24,
            "cm_product_id": 43,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "duration_ms": 4,
            "date": "2022-02-15",
            "recording_expected": true
          }
        ],
        "cm_health_report.cm_physically_disconnected_intervals": [
          {
            "org_id": 1,
            "device_id": 1,
            "linked_cm_id": 1,
            "start_ms": 1644947425235,
            "end_ms": 1644947425239,
            "date": "2022-02-15"
          }
        ],
        "kinesisstats.osddashcamstate": [
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947421104,
            "value": {
              "int_value": 4,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          },
          {
            "org_id": 1,
            "object_id": 1,
            "time": 1644947425234,
            "value": {
              "int_value": 1,
              "is_databreak": false,
              "is_end": false,
              "is_start": false
            },
            "date": "2022-02-15"
          }
        ]
      },
      "expected_data": [
        {
          "vg_device_id": 1,
          "cm_device_id": 1,
          "vg_product_id": 24,
          "cm_product_id": 43,
          "date": "2022-02-15",
          "org_id": 1,
          "start_ms": 1644947425235,
          "end_ms": 1644947425239,
          "duration_ms": 4,
          "interval_connected_duration_ms": 0,
          "interval_recording_start_ms": 1644947425235,
          "recording_expected": true,
          "grace_recording_duration_ms": 0,
          "recording_duration_ms": 0,
          "vg_bootcount": 0,
          "vg_build": null,
          "cm_bootcount": 0,
          "cm_build": null
        }
      ]
    }
  ]
}
