-- Databricks notebook source
--Get device data; need to do this by gateway start and stop date to account for new VGs being installed on previously activated devices
create or replace temporary view devices as
(
  select a.id as gateway_id, 
    a.device_id,
    a.org_id,
    d.product_type,
    d.gw_first_heartbeat_date,
    d.gw_last_heartbeat_date,
    d.has_modi
  from clouddb.gateways as a
  left join clouddb.organizations as c on a.org_id = c.id
  left join ( select distinct org_id, device_id, product_type, gw_first_heartbeat_date, gw_last_heartbeat_date, has_modi
             from data_analytics.dataprep_vg3x_daily_health_metrics) as d on 
             a.org_id = d.org_id 
             and a.device_id = d.device_id
  where a.product_id in (24, 35, 53, 89, 178) and c.internal_type <> 1 and a.org_id not in (1,2,3,4,5,10,11,14,23,36,39,66,138,175,207,216,224,226,227,245,310,349,406,414,472,581,736,769,1232,1326,1363,1440,1531,1571,1577,1774,1782,1787,1956,2046,2206,2274,2390,2425,2603,2605,2611,2718,2782,2785,2883,2895,2959,2960,2961,2962,2963,2965,2997,3121,3129,3159,3160,3161,3180,3204,3317,3364,3365,3366,3386,3401,3433,3553,3556,3610,3743,3744,3745,3746,3748,3749,3750,3752,3753,3754,3756,3757,3760,3846,3983,3986,4039,4348,4389,4462,4463,4619,4635,4838,4869,4888,4910,4953,5137,5289,5437,5791,5928,5941,6076,6081,6085,6086,6087,6090,6091,6147,6149,6150,6165,6179,6183,6227,6229,6254,6274,6380,6450,6478,6558,6615,6672,6685,6766,6876,6899,6909,7013,7049,7056,7140,7169,7250,7265,7269,7298,7299,7312,7313,7320,7428,7854,7941,8068,8072,8150,8282,8285,8321,8570,8602,8656,8677,8712,8717,8830,8907,8954,9068,9134,9135,9136,9183,9189,9224,9249,9297,9298,9299,9341,11422,11476,14228,14285,14287,14444,14581,14594,14603,14645,14668,14669,14670,14692,14716,14753,14776,14804,14805,14895,14944,14983,15030,15031,15062,15071,15126,15144,15147,15169,15201,15221,15261,15323,15386,15514,15525,15531,15606,15663,15774,15775,15823,15899,15948,16275,16367,16478,16482,16483,16484,16490,16497,16668,16747,16750,16753,16766,16775,16776,16795,16797,16801,16999,17017,17028,17030,17036,17050,17226,17281,17282,17283,17293,17294,17297,17301,17306,17341,17359,17491,17534,17540,17541,17548,17549,17552,17593,17713,17830,17831,17899,18015,18018,18071,18075,18078,18090,18093,18094,18101,18102,18103,18131,18135,18137,18141,18156,18164,18201,18277,18279,18433,18552,18589,18665,18688,18689,18692,18693,18697,18709,18710,18727,18729,18740,18997,19005,19011,19019,19093,19299,19302,19318,19319,19335,19344,19346,19455,19576,19577,19588,19592,19744,19868,19895,19974,20029,20127,20254,20420,20487,20488,20490,20603,20804,20945,21057,21140,21145,21149,21181,21212,21262,21266,21495,21520,21695,21745,21746,21764,21775,21865,22251,22366,22489,22523,22604,22631,22632,22635,22660,22661,22731,22929,22942,22945,22947,22949,22950,22951,22952,22953,22955,22956,22958,23050,23076,23181,23265,23266,23356,23357,23374,23425,23525,23527,23542,23545,23585,23658,23726,23760,23797,23963,23986,23999,24058,24072,24109,24112,24139,24190,24244,24278,24338,24362,24364,24474,24598,24690,24743,24806,24818,24835,25017,25093,25104,25135,25386,25388,25401,25403,25584,25678,25683,25771,25773,25774,25775,25776,25848,25850,25878,25939,26041,26100,26254,26303,26389,26391,26512,26634,26731,26745,26854,26884,26974,26984,27116,27143,27144,27304,27330,27331,27455,27469,27647,27702,27924,28044,28071,28073,28156,28180,28199,28243,28257,28258,28259,28278,28279,28343,28373,28528,28616,28689,28709,28908,28919,28995,29047,29053,29093,29105,29129,29145,29163,29231,29440,29536,29571,29688,29868,29872,29935,29963,29973,29974,30098,30116,30358,30614,30891,31035,31051,31061,31112,31113,31266,31460,31609,31867,31952,31961,32181,32345,32388,32428,32477,32824,32966,33055,33449,33521,33759,34108,34124,34302,35068,35069,35278,35589,35724,35802,35807,36212,36910,37288,37313,37323,37378,37508,37530,37983,38394,20471,9368,26821,7163,1197,641,1352,2288,2502,2572,9009,9100,9225,43482,29514,43463,37618,6,44855,46450,47522,22516,41143,5120,45623,44926,43654,33026,40829,39299,48028,43509,43511,43512,43513,43514,43515,43516,43517,43518,43519,43520,43801,43810,43811,46110,46111,46112,46113,46114,46115,46118,46120,46121,46123,46124,215,48532,49349,46412,7586,28848,49587,30,22279,21861,2584,6911,46036,37458,46612,50,43780,51236,51234,51233,50579,16491,43654,50983,51658) 
)

-- COMMAND ----------

--Device daily intervals
create or replace temporary view daily_device_intervals as
(
  select device_id,
    gateway_id, 
    org_id,
    product_type,
    gw_first_heartbeat_date,
    gw_last_heartbeat_date,
    has_modi,
    explode(sequence(date('2020-01-01'), current_date(), interval 1 day)) as date
  from devices
  where gw_first_heartbeat_date <> gw_last_heartbeat_date
)

-- COMMAND ----------

--Build cumulative disconnectivity data
create or replace temporary view cumulative_disconnectivity_by_device_raw as
(
  select device_id,
    gateway_id, 
    org_id,
    product_type,
    gw_first_heartbeat_date,
    gw_last_heartbeat_date,
    date,
    has_modi,
    case 
      when gw_first_heartbeat_date = date then "Activated on date"
      when gw_last_heartbeat_date = date then "Disconnected on date"
      when gw_last_heartbeat_date > date then "Active as of date"
      when gw_last_heartbeat_date < date then "Previously disconnected"
    else "error" end as status
    from daily_device_intervals
    where date >= gw_first_heartbeat_date
)

-- COMMAND ----------

--SFDC data
create or replace temporary view cumulative_disconnectivity_by_device as (
  select a.*,
  b.lifetime_acv,
  b.industry,
  b.region,
  b.status as customer_active,
  b.name as customer_name
  from cumulative_disconnectivity_by_device_raw a
  left join dataprep.customer_metadata as b on
    a.org_id = b.org_id
)

-- COMMAND ----------

create table if not exists data_analytics.cumulative_disconnectivity_by_device_vg3x using delta
partitioned by (date)
select * from cumulative_disconnectivity_by_device

-- COMMAND ----------

insert overwrite table data_analytics.cumulative_disconnectivity_by_device_vg3x
  (
  select * 
  from cumulative_disconnectivity_by_device
  )
